name: Project Manager

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      status:
        description: "Select project status"
        required: false
        type: choice
        options:
          - Not Started
          - In Progress
          - Completed
          - Skip
  schedule:
    - cron: "0 0 * * *" # daily check

permissions:
  contents: write

jobs:
  update_readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Count lines of code
        id: count
        run: |
          lines=$(find . -type f \
            ! -path "./node_modules/*" \
            ! -path "./.git/*" \
            ! -path "./dist/*" \
            ! -path "./build/*" \
            -exec cat {} + | wc -l)
          echo "lines=$lines" >> $GITHUB_ENV

      - name: Get last commit date
        id: commit
        run: |
          last_commit_date=$(git log -1 --format=%cI)
          echo "last_commit_date=$last_commit_date" >> $GITHUB_ENV

      - name: Calculate inactivity duration
        id: calc
        run: |
          now=$(date -u +%s)
          last_commit=$(date -d "${last_commit_date}" +%s)
          diff_days=$(( (now - last_commit) / 86400 ))
          echo "days=$diff_days" >> $GITHUB_ENV

      - name: Determine project status
        id: status
        run: |
          input="${{ github.event.inputs.status }}"
          days=${{ env.days }}
          if [ "$input" = "Skip" ] || [ -z "$input" ]; then
            if [ "$days" -ge 30 ]; then
              new_status="Frozen"
            else
              new_status="Not Started"
            fi
          else
            new_status="$input"
          fi
          echo "new_status=$new_status" >> $GITHUB_ENV

      - name: Format duration
        id: duration
        run: |
          days=${{ env.days }}
          if [ "$days" -lt 30 ]; then
            duration="$days days"
          elif [ "$days" -lt 365 ]; then
            months=$((days / 30))
            duration="$months months"
          else
            years=$((days / 365))
            rem=$(( (days % 365) / 30 ))
            duration="${years} years ${rem} months"
          fi
          echo "duration=$duration" >> $GITHUB_ENV

      - name: Install cloc
        run: sudo apt-get install -y cloc jq

      - name: Get language breakdown
        id: lang
        run: |
          langs=$(cloc . --exclude-dir=node_modules,.git,dist,build --quiet --json)
          table="| Language | Lines |\n|-----------|--------|"
          entries=$(echo "$langs" | jq -r '. | to_entries | map(select(.key!="header" and .key!="SUM")) | sort_by(.value.code) | reverse | .[] | "| \(.key) | \(.value.code) |"')
          if [ -z "$entries" ]; then
            entries="| N/A | 0 |"
          fi
          table="$table\n$entries"
          echo -e "langs_table<<EOF\n$table\nEOF" >> $GITHUB_ENV

      - name: Get repository size
        id: size
        run: |
          size=$(du -sh --exclude=".git" . | cut -f1)
          echo "size=$size" >> $GITHUB_ENV

      - name: Get timestamp
        id: timestamp
        run: |
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "timestamp=$timestamp" >> $GITHUB_ENV

      - name: Ensure README exists
        run: |
          repo_title=$(basename "$GITHUB_REPOSITORY")
          if [ ! -f README.md ]; then
            echo "# $repo_title" > README.md
            echo -e "\n---\n" >> README.md
          fi

      - name: Update README metrics
        run: |
          repo_title=$(basename "$GITHUB_REPOSITORY")

          # Define section content
          metrics_block=$(cat <<EOF
### Status= $new_status ($duration)
### Line Of Code= $lines
### Languages
${{ env.langs_table }}
### Repo Size= ${{ env.size }}
### Last Updated= ${{ env.timestamp }}
EOF
)

          # Remove any existing metric sections
          awk '
            BEGIN {in_block=0}
            /^### Status=/ {in_block=1}
            in_block && /^### / && !/^### Status=/ {in_block=0}
            !in_block
          ' README.md > temp.md || true
          mv temp.md README.md

          # Remove orphaned placeholders if format changes
          sed -i '/^### Line Of Code=/d' README.md
          sed -i '/^### Languages/d' README.md
          sed -i '/^### Repo Size=/d' README.md
          sed -i '/^### Last Updated=/d' README.md

          # Insert fresh ordered metrics section
          if grep -q "^---$" README.md; then
            sed -i "/^---$/a $metrics_block" README.md
          else
            echo -e "\n---\n$metrics_block" >> README.md
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update: LOC=$lines | Status=$new_status ($duration)"
            git push
          else
            echo "No changes to commit."
          fi
